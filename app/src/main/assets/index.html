<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>WebView 调试版 index.html（诊断 + 变量值/链接 + loadWeb 按钮）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans CJK", "PingFang SC", "Microsoft YaHei", sans-serif; margin: 8px; }
    h3 { margin: 6px 0; }
    #log { border: 1px solid #ccc; padding: 8px; height: 42vh; overflow: auto; background:#f9f9f9; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; }
    .INFO { color: #333; }
    .WARN { color: #b76e00; }
    .ERROR{ color: #b00020; }
    .row { margin: 6px 0; }
    input[type="text"] { width: 96%; padding: 6px; font-size: 14px; }
    button { padding: 6px 10px; font-size: 14px; }
    #demoArea { border:1px dashed #ddd; padding:8px; margin-top:8px; }
    #top12 { margin-top:6px; padding:6px; background:#eef; border:1px solid #cde; }
    #linkArea { padding:6px; border:1px dashed #ddd; margin-top:6px; }
    .pill { display:inline-block; margin:2px 4px; padding:2px 6px; border-radius:10px; background:#eef; border:1px solid #cde; font-size:12px; }
  </style>

  <!-- 轻量日志器 -->
  <script>
  (function(){
    var start = Date.now();
    function ts(){ return '[' + (Date.now()-start) + 'ms] '; }
    function append(level, msg){
      var pre = document.getElementById('log');
      var line = ts() + level + ': ' + msg;
      try {
        var div = document.createElement('div');
        div.className = level;
        div.textContent = line;
        pre.appendChild(div);
        pre.scrollTop = pre.scrollHeight;
      } catch(e) {}
    }
    window.L = {
      info: function(m){ append('INFO', m); },
      warn: function(m){ append('WARN', m); },
      error:function(m){ append('ERROR',m); }
    };
  })();
  </script>

  <!-- 捕获脚本错误与资源加载失败 -->
  <script>
  window.addEventListener('error', function(e){
    try{
      if (e && e.target && e.target.tagName === 'SCRIPT') {
        L.error('Script load failed: ' + (e.target.src || '(inline)'));
      } else {
        var where = (e.filename||'') + (e.lineno? (':'+e.lineno):'') + (e.colno? (':'+e.colno):'');
        L.error('Unhandled error: ' + (e.message||e) + (where? (' @ '+where):''));
      }
    }catch(_) {}
  }, true);
  </script>
</head>
<body>
  <h3>WebView/浏览器 运行环境诊断</h3>
  <div id="log" aria-label="日志输出"></div>

  <div class="row">
    <button onclick="runEnvChecks()">运行环境检查</button>
    <button onclick="runPreShimChecks()">预检查（shim 前）</button>
    <button onclick="installShim()">安装 ID 暴露 shim</button>
    <button onclick="runPostShimChecks()">复查（shim 后）</button>
    <button onclick="tryLoadWebjs()">尝试加载 webjs.js</button>
  </div>

  <div class="row">
    <b>loadWeb 调用工具：</b><br>
    <input id="siteUrl" type="text" value="" placeholder="可选：传给 loadWeb(site) 的 site 参数（留空则不传）">
    <button onclick="callLoadWeb()">调用 loadWeb()</button>
  </div>

  <div class="row">
    <label>自定义要检测的 ID（逗号分隔）：</label><br>
    <input id="ids" type="text" value="top12,divDDMXS,d0,inMainleft1,toptu">
    <button onclick="checkIds()">检测这些 ID</button>
  </div>

  <div class="row">
    <b>变量工具：</b><br>
    <input id="varName" type="text" value="lateNode" placeholder="输入变量名，例如 lateNode">
    <button onclick="showVar()">显示变量值</button>
    <button onclick="makeLink()">生成链接（形如 变量/0）</button>
    <div id="linkArea"></div>
  </div>

  <div id="demoArea">
    <b>页面内置示例节点（用于最小化复现）：</b>
    <div id="top12">示例：id="top12" 的节点（调试页自带）</div>
    <div id="divDDMXS" style="display:none">示例：id="divDDMXS"</div>
    <div id="d0" style="display:none">示例：id="d0"</div>
  </div>

  <script>
    // 小工具：生成节点摘要字符串
    function summarizeNode(n){
      if (!n) return '(null/undefined)';
      try{
        var txt = (n.textContent||'').replace(/\s+/g,' ').slice(0,60);
        return [
          'id="'+(n.id||'')+'"',
          'tag='+ (n.tagName||''),
          (n.className? ('class="'+n.className+'"') : ''),
          'text="'+txt+'"'
        ].filter(Boolean).join(', ');
      }catch(e){ return '[uninspectable node: '+e+']'; }
    }

    function runEnvChecks(){
      L.info('UserAgent: ' + navigator.userAgent);
      L.info('Location: '  + location.href);
      L.info('Protocol: '  + location.protocol + '（file:// 在 4.4 下不支持 SW）');
      var feats = [
        ['serviceWorker', (typeof navigator !== 'undefined' && 'serviceWorker' in navigator)],
        ['fetch',         ('fetch'   in window)],
        ['Promise',       ('Promise' in window)],
        ['MutationObserver', ('MutationObserver' in window)],
        ['CSS.supports',  ('CSS' in window && 'supports' in CSS)]
      ];
      for (var i=0;i<feats.length;i++){
        L.info('Feature ' + feats[i][0] + ': ' + feats[i][1]);
      }
    }

    function runPreShimChecks(){
      try{ top12.style.border = '1px solid #0c0'; L.info('Pre-shim: top12 变量可用'); }
      catch(e){ L.warn('Pre-shim: top12 变量不可用（undefined） => ' + e); }
      try{ d0.style.display = 'block'; L.info('Pre-shim: d0 变量可用'); }
      catch(e){ L.warn('Pre-shim: d0 变量不可用（undefined） => ' + e); }
    }

    // 安装把所有 id 显式挂到 window 的 shim（方案 A 的核心）
    var __shimInstalled = false;
    function installShim(){
      if (__shimInstalled){ L.info('shim 已安装'); return; }
      (function exposeIdsToWindow(){
        function expose(el){
          var id = el && el.id;
          if (id && !(id in window)) window[id] = el;
        }
        try {
          var els = document.querySelectorAll('[id]');
          for (var i=0;i<els.length;i++) expose(els[i]);
          try{
            new MutationObserver(function(muts){
              for (var k=0;k<muts.length;k++){
                var nodes = muts[k].addedNodes || [];
                for (var j=0;j<nodes.length;j++){
                  var n = nodes[j];
                  if (n.nodeType === 1){
                    expose(n);
                    if (n.querySelectorAll){
                      var all = n.querySelectorAll('[id]');
                      for (var i2=0;i2<all.length;i2++) expose(all[i2]);
                    }
                  }
                }
              }
            }).observe(document.documentElement, {subtree:true, childList:true});
          }catch(_) {}
          __shimInstalled = true;
          L.info('shim 安装完成。window.top12 类型：' + (typeof window.top12));
        } catch(e){
          L.error('安装 shim 失败：' + e);
        }
      })();
    }

    function runPostShimChecks(){
      try{ top12.style.backgroundColor = '#efe'; L.info('Post-shim: top12 变量可用'); }
      catch(e){ L.error('Post-shim: top12 变量仍不可用 => ' + e); }
      try{ d0.style.display = 'block'; L.info('Post-shim: d0 变量可用'); }
      catch(e){ L.error('Post-shim: d0 变量仍不可用 => ' + e); }
    }

    // 批量检查一组 id：比较 window[id] 与 document.getElementById(id)
    function checkIds(){
      var raw = document.getElementById('ids').value || '';
      var arr = raw.split(/\s*,\s*/);
      for (var i=0;i<arr.length;i++){
        var id = arr[i];
        if (!id) continue;
        var byVar = window[id];
        var byGet = document.getElementById(id);
        L.info('ID "'+id+'": window.'+id+' = ' + (byVar ? 'OK' : 'undefined')
               + ', getElementById = ' + (byGet ? 'OK' : 'null'));
      }
      // 动态新增一个节点，验证 MutationObserver 是否把它挂到 window
      var late = document.createElement('div'); late.id = 'lateNode'; late.textContent = '动态新增: lateNode';
      document.body.appendChild(late);
      // 这里输出 lateNode 的“值摘要”
      L.info('已新增 id="lateNode"。window.lateNode 类型：' + (typeof window.lateNode));
      L.info('lateNode 值: ' + summarizeNode(window.lateNode));

      // 同时生成并显示一个“组成的链接”示例：lateNode/0
      addComposedLink('lateNode', 0);
    }

    // 变量工具：显示变量值
    function showVar(){
      var name = (document.getElementById('varName').value || '').trim();
      if (!name) { L.warn('变量工具：请输入变量名'); return; }
      var v = window[name];
      if (!v) { L.warn('变量工具：window.'+name+' 不存在/未定义'); return; }
      L.info('window.'+name+' 类型：' + (typeof v));
      if (typeof v === 'object') {
        L.info(name+' 值: ' + summarizeNode(v));
      } else {
        try { L.info(name+' 值（非节点）：' + String(v)); }
        catch(e){ L.info(name+' 值（不可转字符串）'); }
      }
    }

    // 变量工具：生成链接 “变量/0”
    function makeLink(){
      var name = (document.getElementById('varName').value || '').trim();
      if (!name) { L.warn('变量工具：请输入变量名'); return; }
      addComposedLink(name, 0);
    }

    // 在面板中添加由“名称/索引”组成的可点击链接（使用哈希，避免 file:// 真跳转）
    function addComposedLink(name, idx){
      var area = document.getElementById('linkArea');
      var a = document.createElement('a');
      var linkText = name + '/' + idx;
      a.textContent = linkText;
      a.href = '#' + linkText;
      a.className = 'pill';
      a.onclick = function(ev){
        ev.preventDefault();
        L.info('已点击链接：' + linkText + '（哈希跳转，未离开当前页）');
        location.hash = linkText;
      };
      area.appendChild(a);
      L.info('生成链接：' + linkText);
    }

    // 确保 webjs.js 已加载，然后回调
    var __webjsLoading = false, __webjsLoaded = false, __webjsWaiters = [];
    function ensureWebjsLoaded(cb){
      if (__webjsLoaded) return cb && cb();
      __webjsWaiters.push(cb);
      if (__webjsLoading) return;
      __webjsLoading = true;
      var s = document.createElement('script');
      s.src = 'webjs.js';
      s.onload = function(){
        __webjsLoaded = true;
        L.info('webjs.js 加载成功');
        L.info('window.loadWeb 类型：' + (typeof window.loadWeb));
        var list = __webjsWaiters.slice(); __webjsWaiters.length = 0;
        for (var i=0;i<list.length;i++) try { list[i] && list[i](); } catch(e){ L.error('webjs 回调异常：'+e); }
      };
      s.onerror = function(){
        L.error('webjs.js NOT found 或加载失败（路径/文件缺失）。');
        var list = __webjsWaiters.slice(); __webjsWaiters.length = 0;
        for (var i=0;i<list.length;i++) try { list[i] && list[i](); } catch(e){}
      };
      document.head.appendChild(s);
    }

    // 手动加载 webjs.js（供按钮使用）
    function tryLoadWebjs(){ ensureWebjsLoaded(function(){ L.info('tryLoadWebjs: 已加载'); }); }

    // 调用 loadWeb(site) 的按钮逻辑
    function callLoadWeb(){
      var site = (document.getElementById('siteUrl').value || '').trim();
      ensureWebjsLoaded(function(){
        if (typeof window.loadWeb !== 'function') {
          L.warn('loadWeb 未定义，无法调用。请检查 webjs.js 是否包含该方法。');
          return;
        }
        try {
          if (site) {
            L.info('调用 loadWeb(site)；site = ' + site);
            window.loadWeb(site);
          } else {
            L.info('调用 loadWeb()（无参数）');
            window.loadWeb();
          }
        } catch(e){
          L.error('调用 loadWeb 抛出异常：' + e);
        }
      });
    }

    // 首屏：自动跑一次环境检查 + 预检查
    runEnvChecks();
    runPreShimChecks();
  </script>
</body>
</html>
